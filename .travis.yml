sudo: required

language: bash

services:
    - docker

before_install:
    - docker pull multiarch/qemu-user-static:register
    - docker run --rm --privileged multiarch/qemu-user-static:register --reset
    - docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD"
script:
    - make TARGET=arm64
    - make TARGET=amd64
    - make TARGET=armhf
    - make TARGET=i386
    - make TARGET=ppc64el
    - make TARGET=armel
    - make TARGET=s390x

after_success:
    - if [[ $TRAVIS_PULL_REQUEST == 'false' ]]; then docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD" && docker push $DOCKER_REPO; fi
    - echo "Downloading manifest-tool"
    - wget https://github.com/estesp/manifest-tool/releases/download/v0.7.0/manifest-tool-linux-amd64
    - mv manifest-tool-linux-amd64 manifest-tool
    - chmod +x manifest-tool
    - ./manifest-tool
    - echo "Pushing manifest $DOCKER_REPO:latest"
    - ./manifest-generate.sh $DOCKER_USERNAME $DOCKER_PASSWORD
